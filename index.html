<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>Tap Coin Mini App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        :root {
            --bg-main: radial-gradient(circle at top, #050016 0, #02000a 45%, #000 100%);

            --accent: #5fa8ff;
            --accent-soft: #9fd1ff;
            --accent-deep: #1f68ff;

            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-stroke: rgba(255, 255, 255, 0.18);
            --glass-shadow: 0 24px 60px rgba(0, 0, 0, 0.7);

            --text-main: #f5f5ff;
            --text-soft: #b3b9d9;
            --text-muted: #7b809c;

            --danger: #ff4b6a;
            --success: #4ce1a1;

            --radius-lg: 24px;
            --radius-md: 18px;
            --radius-sm: 12px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Roboto", sans-serif;
            color: var(--text-main);
            background: var(--bg-main);
            overflow: hidden;
        }

        .app-root {
            height: 100vh;
            max-width: 480px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            padding: 12px 12px 20px;
            position: relative;
        }

        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 10px 14px;
            border-radius: var(--radius-md);
            background: linear-gradient(135deg, rgba(95,168,255,0.25), rgba(15,20,45,0.85));
            border: 1px solid rgba(148, 204, 255, 0.4);
            box-shadow: 0 18px 45px rgba(0,0,0,0.8);
            backdrop-filter: blur(28px);
        }

        .app-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .app-logo {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ffffff, #9fd1ff 40%, #1f68ff 75%, #040818 100%);
            box-shadow: 0 0 24px rgba(95,168,255,0.9);
            position: relative;
            overflow: hidden;
        }

        .app-logo::after {
            content: "V";
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 18px;
            color: rgba(255,255,255,0.9);
            text-shadow: 0 0 12px rgba(0,0,0,0.8);
        }

        .app-title-block {
            display: flex;
            flex-direction: column;
        }

        .app-title {
            font-size: 16px;
            font-weight: 600;
            letter-spacing: 0.02em;
        }

        .app-subtitle {
            font-size: 11px;
            color: var(--text-soft);
        }

        .app-header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pill {
            padding: 5px 9px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.22);
            background: radial-gradient(circle at 0 0, rgba(255,255,255,0.35), rgba(30,40,80,0.7));
            font-size: 11px;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pill-dot {
            width: 6px;
            height: 6px;
            border-radius: 999px;
            background: var(--success);
            box-shadow: 0 0 6px rgba(76,225,161,0.9);
        }

        .pill-label {
            opacity: 0.8;
        }

        /* MAIN CONTENT AREA */
        .app-content {
            flex: 1;
            position: relative;
            margin-top: 6px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .screen {
            position: absolute;
            inset: 0;
            padding: 8px 2px 6px;
            opacity: 0;
            pointer-events: none;
            transform: translateX(8px);
            transition: opacity 0.18s ease-out, transform 0.18s ease-out;
        }

        .screen.active {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(0);
        }

        /* GLASS CARD */
        .glass-card {
            background: radial-gradient(circle at top left, rgba(255,255,255,0.18), rgba(255,255,255,0.06));
            background-color: var(--glass-bg);
            border-radius: var(--radius-lg);
            border: 1px solid var(--glass-stroke);
            box-shadow: var(--glass-shadow);
            backdrop-filter: blur(26px);
            -webkit-backdrop-filter: blur(26px);
        }

        .glass-section {
            padding: 14px 16px;
            margin-bottom: 10px;
        }

        .glass-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .section-title {
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.02em;
        }

        .section-subtitle {
            font-size: 11px;
            color: var(--text-soft);
        }

        /* HOME SCREEN */
        .balance-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .balance-main {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .balance-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--text-muted);
        }

        .balance-value {
            font-size: 26px;
            font-weight: 700;
            letter-spacing: 0.03em;
            display: flex;
            align-items: baseline;
            gap: 4px;
        }

        .balance-value span:nth-child(2) {
            font-size: 14px;
            color: var(--accent-soft);
            opacity: 0.9;
        }

        .balance-change {
            font-size: 11px;
            color: var(--accent-soft);
            opacity: 0.8;
        }

        .per-tap-pill {
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.22);
            background: linear-gradient(135deg, rgba(95,168,255,0.3), rgba(15,20,45,0.8));
            font-size: 11px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .per-tap-pill-icon {
            width: 14px;
            height: 14px;
            border-radius: 7px;
            background: radial-gradient(circle at 30% 20%, #ffffff, #9fd1ff 45%, #1f68ff 90%);
            box-shadow: 0 0 10px rgba(95,168,255,0.9);
        }

        .tap-analytics {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            font-size: 11px;
            color: var(--text-soft);
        }

        .tap-analytics span strong {
            color: var(--text-main);
        }

        .coin-zone {
            margin-top: 10px;
            padding: 16px 12px 18px;
            text-align: center;
        }

        .coin-wrapper {
            position: relative;
            width: 190px;
            height: 190px;
            margin: 0 auto 10px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
            transform: translateZ(0);
        }

        .coin-glow {
            position: absolute;
            inset: 12px;
            border-radius: inherit;
            background: radial-gradient(circle at 30% 0, rgba(159, 209, 255, 0.8), rgba(4, 8, 24, 0));
            filter: blur(8px);
            opacity: 0.85;
        }

        .coin-plate {
            position: relative;
            inset: 0;
            border-radius: inherit;
            background:
                radial-gradient(circle at 30% 30%, #e6f3ff, #9fd1ff 35%, #1f68ff 60%, #040818 95%);
            box-shadow:
                0 0 50px rgba(104, 179, 255, 0.7),
                0 18px 45px rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(255,255,255,0.35);
            transform: perspective(700px) rotateX(13deg) rotateY(-12deg);
            overflow: hidden;
        }

        .coin-highlight-ring {
            position: absolute;
            inset: 10%;
            border-radius: inherit;
            border: 1px solid rgba(255,255,255,0.53);
            opacity: 0.7;
        }

        .coin-inner {
            position: absolute;
            inset: 25%;
            border-radius: inherit;
            background: radial-gradient(circle at 30% 20%, #f6fbff, #bfdcff 50%, #2659d8 100%);
            border: 1px solid rgba(255,255,255,0.7);
            box-shadow: inset 0 0 18px rgba(0,0,0,0.35);
        }

        .coin-letter {
            position: absolute;
            inset: 28%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 70px;
            color: rgba(6, 20, 60, 0.9);
            text-shadow:
                0 1px 0 rgba(255,255,255,0.7),
                0 -2px 3px rgba(0,0,0,0.55),
                0 0 26px rgba(255,255,255,0.7);
        }

        .coin-glare {
            position: absolute;
            top: -15%;
            left: -15%;
            width: 70%;
            height: 45%;
            border-radius: 60%;
            background: linear-gradient(135deg, rgba(255,255,255,0.75), transparent 60%);
            filter: blur(8px);
            opacity: 0.8;
        }

        .coin-wrapper:active .coin-plate {
            transform: perspective(700px) rotateX(17deg) rotateY(-6deg) scale(0.97);
            box-shadow:
                0 0 40px rgba(104, 179, 255, 0.65),
                0 12px 30px rgba(0, 0, 0, 0.9);
        }

        .coin-wrapper.tap-anim .coin-plate {
            animation: pulse 0.19s ease-out;
        }

        @keyframes pulse {
            0% { transform: perspective(700px) rotateX(13deg) rotateY(-12deg) scale(1); }
            50% { transform: perspective(700px) rotateX(16deg) rotateY(-9deg) scale(0.96); }
            100% { transform: perspective(700px) rotateX(13deg) rotateY(-12deg) scale(1); }
        }

        .tap-hint {
            font-size: 12px;
            color: var(--text-soft);
            margin-bottom: 4px;
        }

        .tap-gain {
            font-size: 13px;
            color: var(--accent-soft);
        }

        .tap-gain span {
            font-weight: 600;
            color: #ffffff;
        }

        .tap-float {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -10px);
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
            text-shadow: 0 0 8px rgba(0,0,0,0.7);
            opacity: 0;
            pointer-events: none;
        }

        .tap-float.show {
            animation: floatUp 0.4s ease-out forwards;
        }

        @keyframes floatUp {
            0%   { opacity: 1; transform: translate(-50%, -6px); }
            100% { opacity: 0; transform: translate(-50%, -32px); }
        }

        /* TASKS SCREEN */
        .tasks-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 4px;
        }

        .task-item {
            padding: 10px 12px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(255,255,255,0.2);
            background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(20,30,70,0.85));
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .task-top {
            display: flex;
            justify-content: space-between;
            gap: 8px;
        }

        .task-title {
            font-size: 13px;
            font-weight: 500;
        }

        .task-reward {
            font-size: 11px;
            color: var(--accent-soft);
            white-space: nowrap;
        }

        .task-desc {
            font-size: 11px;
            color: var(--text-soft);
        }

        .task-bottom {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .task-status {
            font-size: 11px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .task-status-dot {
            width: 7px;
            height: 7px;
            border-radius: 999px;
            background: var(--accent-soft);
        }

        .task-status.completed .task-status-dot {
            background: var(--success);
        }

        .task-status.completed span {
            color: var(--success);
        }

        .task-actions {
            display: flex;
            gap: 6px;
        }

        .btn {
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.32);
            padding: 6px 10px;
            font-size: 11px;
            font-weight: 500;
            background: linear-gradient(135deg, rgba(95,168,255,0.65), rgba(10,15,35,0.9));
            color: #ffffff;
            cursor: pointer;
            outline: none;
        }

        .btn.secondary {
            background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(8,12,30,0.9));
            color: var(--text-soft);
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn[disabled] {
            opacity: 0.4;
            cursor: default;
            transform: none;
        }

        /* LEADERBOARD SCREEN */
        .lb-user-card,
        .lb-list {
            margin-top: 6px;
        }

        .lb-user-card {
            padding: 11px 13px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(255,255,255,0.28);
            background: linear-gradient(135deg, rgba(95,168,255,0.35), rgba(15,20,45,0.9));
            display: flex;
            align-items: center;
            gap: 11px;
        }

        .lb-rank-circle {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.45);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
        }

        .lb-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ffffff, #9fd1ff 40%, #1f68ff 75%, #040818 100%);
            overflow: hidden;
            flex-shrink: 0;
        }

        .lb-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .lb-user-main {
            flex: 1;
        }

        .lb-user-name {
            font-size: 13px;
            font-weight: 500;
        }

        .lb-user-handle {
            font-size: 11px;
            color: var(--text-soft);
        }

        .lb-user-score {
            font-size: 12px;
            font-weight: 600;
            text-align: right;
        }

        .lb-user-score span {
            font-size: 11px;
            font-weight: 400;
            color: var(--accent-soft);
        }

        .lb-list {
            max-height: calc(100% - 110px);
            overflow-y: auto;
            padding-right: 4px;
        }

        .lb-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 7px 6px;
            border-radius: var(--radius-sm);
            border: 1px solid rgba(255,255,255,0.1);
            background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(8,12,30,0.9));
            font-size: 11px;
        }

        .lb-row-rank {
            width: 24px;
            text-align: center;
            color: var(--text-soft);
        }

        .lb-row-name {
            flex: 1;
        }

        .lb-row-score {
            font-weight: 500;
        }

        .lb-row-score span {
            font-size: 10px;
            color: var(--accent-soft);
        }

        .lb-row.you {
            border-color: rgba(159,209,255,0.7);
            background: linear-gradient(135deg, rgba(95,168,255,0.16), rgba(15,20,45,0.95));
        }

        .lb-footer-note {
            margin-top: 6px;
            font-size: 10px;
            color: var(--text-muted);
            text-align: center;
        }

        /* UPGRADES SCREEN */
        .upgrades-info {
            font-size: 11px;
            color: var(--text-soft);
            margin-top: 4px;
        }

        .upgrades-list {
            margin-top: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .upgrade-item {
            padding: 10px 12px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(255,255,255,0.22);
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(14,20,46,0.9));
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .upgrade-top {
            display: flex;
            justify-content: space-between;
            gap: 8px;
        }

        .upgrade-title {
            font-size: 13px;
            font-weight: 500;
        }

        .upgrade-badge {
            padding: 2px 7px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.3);
            font-size: 10px;
            color: var(--accent-soft);
        }

        .upgrade-desc {
            font-size: 11px;
            color: var(--text-soft);
        }

        .upgrade-bottom {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .upgrade-price {
            font-size: 12px;
            color: var(--accent-soft);
        }

        .upgrade-price span {
            font-size: 11px;
            color: var(--text-muted);
        }

        .btn-danger {
            background: linear-gradient(135deg, rgba(255,75,106,0.9), rgba(150,20,60,0.95));
        }

        .upgrade-item.unlocked {
            border-color: rgba(76,225,161,0.7);
            background: linear-gradient(135deg, rgba(76,225,161,0.18), rgba(6,18,28,0.95));
        }

        .upgrade-item.unlocked .upgrade-badge {
            color: var(--success);
            border-color: rgba(76,225,161,0.8);
        }

        .upgrade-item.unlocked .upgrade-price {
            color: var(--success);
        }

        /* BOTTOM NAV */
        .bottom-nav-wrap {
            position: relative;
            padding: 10px 16px 12px;
        }

        .bottom-nav {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 6px;
            padding: 8px 10px;
            border-radius: 999px;
            background: radial-gradient(circle at top, rgba(255,255,255,0.22), rgba(10,10,30,0.95));
            background-color: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.28);
            box-shadow: 0 18px 45px rgba(0,0,0,0.9);
            backdrop-filter: blur(28px);
            -webkit-backdrop-filter: blur(28px);
        }

        .nav-indicator {
            position: absolute;
            top: 5px;
            bottom: 5px;
            width: 24%;
            border-radius: 999px;
            background: linear-gradient(135deg, rgba(95,168,255,0.45), rgba(8,10,32,0.98));
            box-shadow: 0 10px 25px rgba(95,168,255,0.6);
            transform: translateX(0%);
            transition: transform 0.18s ease-out;
            z-index: 1;
        }

        .nav-btn {
            position: relative;
            z-index: 2;
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            padding: 4px 2px 2px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            cursor: pointer;
            color: var(--text-soft);
            font-size: 9px;
        }

        .nav-btn svg {
            width: 20px;
            height: 20px;
            display: block;
        }

        .nav-btn.active {
            color: #ffffff;
        }

        .nav-btn span {
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        .nav-btn svg path {
            opacity: 0.7;
        }

        .nav-btn.active svg path {
            opacity: 1;
        }

        /* SCROLLBARS */
        .lb-list::-webkit-scrollbar {
            width: 3px;
        }

        .lb-list::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.26);
            border-radius: 999px;
        }

        /* SMALL SCREENS */
        @media (max-height: 640px) {
            .coin-wrapper {
                width: 170px;
                height: 170px;
            }
        }
    </style>
</head>
<body>
<div class="app-root">
    <!-- HEADER -->
    <header class="app-header">
        <div class="app-header-left">
            <div class="app-logo"></div>
            <div class="app-title-block">
                <div class="app-title">Tap Glass</div>
                <div class="app-subtitle" id="userLabel">Loading…</div>
            </div>
        </div>
        <div class="app-header-right">
            <div class="pill">
                <div class="pill-dot"></div>
                <div class="pill-label" id="sessionStat">Session 0 taps</div>
            </div>
        </div>
    </header>

    <!-- CONTENT -->
    <main class="app-content">
        <!-- HOME -->
        <section class="screen active" id="screen-home" data-tab="home">
            <div class="glass-card glass-section">
                <div class="glass-section-header">
                    <div>
                        <div class="section-title">Баланс</div>
                        <div class="section-subtitle">Твои V-монеты</div>
                    </div>
                    <div class="per-tap-pill">
                        <div class="per-tap-pill-icon"></div>
                        <div><span id="perTapValue">+1</span> за тап</div>
                    </div>
                </div>
                <div class="balance-row">
                    <div class="balance-main">
                        <div class="balance-label">Всего</div>
                        <div class="balance-value">
                            <span id="balanceValue">0</span><span>V</span>
                        </div>
                        <div class="balance-change" id="balanceChange"></div>
                    </div>
                </div>
                <div class="tap-analytics">
                    <span>За сессию: <strong id="sessionTapsValue">0</strong> тапов</span>
                    <span>Всего тапов: <strong id="totalTapsValue">0</strong></span>
                </div>
            </div>

            <div class="glass-card coin-zone">
                <div class="coin-wrapper" id="coin">
                    <div class="coin-glow"></div>
                    <div class="coin-plate">
                        <div class="coin-highlight-ring"></div>
                        <div class="coin-inner"></div>
                        <div class="coin-letter">V</div>
                        <div class="coin-glare"></div>
                    </div>
                    <div class="tap-float" id="tapFloat">+1</div>
                </div>
                <div class="tap-hint">Тапай по монете, чтобы зарабатывать V-монеты</div>
                <div class="tap-gain">Текущий множитель: <span id="tapMultiplierLabel">x1</span></div>
            </div>
        </section>

        <!-- TASKS -->
        <section class="screen" id="screen-tasks" data-tab="tasks">
            <div class="glass-card glass-section">
                <div class="glass-section-header">
                    <div>
                        <div class="section-title">Задания</div>
                        <div class="section-subtitle">Подписки и активности за звёзды</div>
                    </div>
                </div>
                <div class="tasks-list" id="tasksList">
                    <!-- JS заполнит -->
                </div>
            </div>
        </section>

        <!-- LEADERBOARD -->
        <section class="screen" id="screen-leaderboard" data-tab="leaderboard">
            <div class="glass-card glass-section" style="height: 100%; display: flex; flex-direction: column;">
                <div class="glass-section-header">
                    <div>
                        <div class="section-title">Лидерборд</div>
                        <div class="section-subtitle">Топ игроков по V-монетам</div>
                    </div>
                    <button class="btn secondary" id="refreshLeaderboardBtn" style="padding-inline: 10px;">Обновить</button>
                </div>

                <div class="lb-user-card" id="lbUserCard">
                    <div class="lb-rank-circle" id="lbUserRank">–</div>
                    <div class="lb-avatar" id="lbUserAvatar">
                        <!-- если есть фото, подставим img -->
                    </div>
                    <div class="lb-user-main">
                        <div class="lb-user-name" id="lbUserName">You</div>
                        <div class="lb-user-handle" id="lbUserHandle">@you</div>
                    </div>
                    <div class="lb-user-score" id="lbUserScore">
                        0<span> V</span>
                    </div>
                </div>

                <div class="lb-list" id="lbList">
                    <!-- JS заполнит -->
                </div>

                <div class="lb-footer-note">
                    Данные берутся с сервера по initData. Обновляй, чтобы увидеть актуальный топ.
                </div>
            </div>
        </section>

        <!-- UPGRADES -->
        <section class="screen" id="screen-upgrades" data-tab="upgrades">
            <div class="glass-card glass-section">
                <div class="glass-section-header">
                    <div>
                        <div class="section-title">Апгрейды</div>
                        <div class="section-subtitle">Усиления за Telegram Stars</div>
                    </div>
                </div>
                <div class="upgrades-info">
                    Покупай апгрейды за звёзды через <b>openInvoice</b>, чтобы увеличить доход с каждого тапа.
                </div>
                <div class="upgrades-list" id="upgradesList">
                    <!-- JS заполнит -->
                </div>
            </div>
        </section>
    </main>

    <!-- BOTTOM NAV -->
    <div class="bottom-nav-wrap">
        <div class="bottom-nav">
            <div class="nav-indicator" id="navIndicator"></div>

            <button class="nav-btn active" data-tab-target="home">
                <svg viewBox="0 0 24 24">
                    <path d="M4.5 10.5L12 4.8l7.5 5.7V19a1.5 1.5 0 0 1-1.5 1.5h-3.75a.75.75 0 0 1-.75-.75v-4.5h-3v4.5a.75.75 0 0 1-.75.75H6A1.5 1.5 0 0 1 4.5 19v-8.5z" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Дом</span>
            </button>

            <button class="nav-btn" data-tab-target="tasks">
                <svg viewBox="0 0 24 24">
                    <path d="M7.5 4.5h9a1.5 1.5 0 0 1 1.5 1.5v12a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 6 18V6a1.5 1.5 0 0 1 1.5-1.5z" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
                    <path d="M9 9h6M9 12h3.5M9 15h4.5M10 3h4" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Задачи</span>
            </button>

            <button class="nav-btn" data-tab-target="leaderboard">
                <svg viewBox="0 0 24 24">
                    <path d="M6 10.5v9M12 5.5v14M18 8v11.5" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
                    <path d="M4 10.5h4M10 5.5h4M16 8h4" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Топ</span>
            </button>

            <button class="nav-btn" data-tab-target="upgrades">
                <svg viewBox="0 0 24 24">
                    <path d="M7.5 5h9l1.5 4.5-6 9-6-9L7.5 5z" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
                    <path d="M10 9l2 2 2-2" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Буст</span>
            </button>
        </div>
    </div>
</div>

<script>
    // ==============================
    // 1. Telegram Mini App интеграция
    // ==============================
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if (tg) {
        tg.ready();
        tg.expand();
    }

    const initDataUnsafe = tg ? tg.initDataUnsafe : {};
    const currentUser = initDataUnsafe.user || null;

    // ==============================
    // 2. Базовые переменные игры
    // ==============================
    let balance = 0;
    let perTap = 1;
    let tapMultiplier = 1;
    let totalTaps = 0;
    let sessionTaps = 0;

    // для апгрейдов: локальное состояние
    const upgrades = [
        {
            id: 'tap_x2',
            title: 'x2 Tap Boost',
            description: 'Удваивает доход за тап навсегда.',
            priceStars: 25,
            levelLabel: 'Epic',
            unlocked: false,
        },
        {
            id: 'tap_x3',
            title: 'x3 Tap Boost',
            description: 'Тройной доход за каждый тап.',
            priceStars: 60,
            levelLabel: 'Legendary',
            unlocked: false,
        },
        {
            id: 'auto_miner',
            title: 'Auto Miner',
            description: 'Пассивный доход каждую минуту.',
            priceStars: 80,
            levelLabel: 'Utility',
            unlocked: false,
        }
    ];

    // Задания (пример)
    const tasks = [
        {
            id: 'sub_main',
            title: 'Подписаться на основной канал',
            description: 'Нажми "Начать" и подпишись на канал.',
            reward: 3,
            link: 'https://t.me/your_channel',
            status: 'new' // new | pending | completed
        },
        {
            id: 'sub_chat',
            title: 'Вступить в чат комьюнити',
            description: 'Заходи в чат и общайся с другими игроками.',
            reward: 3,
            link: 'https://t.me/your_chat',
            status: 'new'
        }
    ];

    // ==============================
    // 3. Настройки API (замени на свои)
    // ==============================
    const API_BASE = 'https://your-backend.com'; // <--- Свой домен
    const LEADERBOARD_API = API_BASE + '/api/leaderboard';
    const TASK_CHECK_API = API_BASE + '/api/tasks/check';
    const UPGRADE_APPLY_API = API_BASE + '/api/upgrades/apply';

    // Пример ссылки инвойса (замени на свою)
    // Можно передавать query-параметр upgradeId, чтобы бот понимал, за что платёж
    const INVOICE_BASE_URL = 'https://t.me/$iPEf6FFc0EiyFgAAmNOfe7Gn8oA';

    // ==============================
    // 4. DOM-элементы
    // ==============================
    const balanceValueEl = document.getElementById('balanceValue');
    const perTapValueEl = document.getElementById('perTapValue');
    const tapMultiplierLabelEl = document.getElementById('tapMultiplierLabel');
    const balanceChangeEl = document.getElementById('balanceChange');
    const sessionTapsValueEl = document.getElementById('sessionTapsValue');
    const totalTapsValueEl = document.getElementById('totalTapsValue');
    const sessionStatEl = document.getElementById('sessionStat');
    const userLabelEl = document.getElementById('userLabel');
    const tapFloatEl = document.getElementById('tapFloat');
    const coinEl = document.getElementById('coin');

    const tasksListEl = document.getElementById('tasksList');
    const upgradesListEl = document.getElementById('upgradesList');

    const lbUserRankEl = document.getElementById('lbUserRank');
    const lbUserAvatarEl = document.getElementById('lbUserAvatar');
    const lbUserNameEl = document.getElementById('lbUserName');
    const lbUserHandleEl = document.getElementById('lbUserHandle');
    const lbUserScoreEl = document.getElementById('lbUserScore');
    const lbListEl = document.getElementById('lbList');
    const refreshLeaderboardBtn = document.getElementById('refreshLeaderboardBtn');

    const navButtons = Array.from(document.querySelectorAll('.nav-btn'));
    const screens = Array.from(document.querySelectorAll('.screen'));
    const navIndicatorEl = document.getElementById('navIndicator');

    // ==============================
    // 5. Инициализация пользователя
    // ==============================
    function initUserInfo() {
        if (currentUser) {
            const name = [currentUser.first_name, currentUser.last_name].filter(Boolean).join(' ');
            userLabelEl.textContent = name || 'Player';
            lbUserNameEl.textContent = name || 'Player';
            lbUserHandleEl.textContent = currentUser.username ? '@' + currentUser.username : 'без юзернейма';

            if (currentUser.photo_url) {
                const img = document.createElement('img');
                img.src = currentUser.photo_url;
                img.alt = 'avatar';
                lbUserAvatarEl.innerHTML = '';
                lbUserAvatarEl.appendChild(img);
            } else {
                lbUserAvatarEl.innerHTML = '';
            }
        } else {
            userLabelEl.textContent = 'Гость';
            lbUserNameEl.textContent = 'Гость';
            lbUserHandleEl.textContent = '';
        }
    }

    // ==============================
    // 6. Обновление UI
    // ==============================
    function updateBalanceUI(diff = 0) {
        balanceValueEl.textContent = balance.toString();
        totalTapsValueEl.textContent = totalTaps.toString();
        sessionTapsValueEl.textContent = sessionTaps.toString();
        sessionStatEl.textContent = `Session ${sessionTaps} taps`;

        if (diff !== 0) {
            const sign = diff > 0 ? '+' : '';
            balanceChangeEl.textContent = `${sign}${diff} V`;
            balanceChangeEl.style.opacity = '1';
            setTimeout(() => {
                balanceChangeEl.style.opacity = '0';
            }, 550);
        } else {
            balanceChangeEl.textContent = '';
        }
    }

    function updateTapInfoUI() {
        perTapValueEl.textContent = `+${perTap}`;
        tapMultiplierLabelEl.textContent = `x${tapMultiplier}`;
    }

    function showTapFloat(value) {
        tapFloatEl.textContent = `+${value}`;
        tapFloatEl.classList.remove('show');
        // перезапуск анимации
        void tapFloatEl.offsetWidth;
        tapFloatEl.classList.add('show');
    }

    // ==============================
    // 7. Логика тапа
    // ==============================
    function handleTap() {
        const gain = perTap * tapMultiplier;
        balance += gain;
        totalTaps += 1;
        sessionTaps += 1;

        updateBalanceUI(gain);
        showTapFloat(gain);
        coinEl.classList.add('tap-anim');
        setTimeout(() => coinEl.classList.remove('tap-anim'), 190);

        // TODO: при желании отправлять на сервер статистику тапа
        // sendTapToServer(gain);
    }

    coinEl.addEventListener('click', handleTap);

    // ==============================
    // 8. Навигация по вкладкам
    // ==============================
    function setActiveTab(tabName) {
        screens.forEach(screen => {
            if (screen.dataset.tab === tabName) {
                screen.classList.add('active');
            } else {
                screen.classList.remove('active');
            }
        });

        navButtons.forEach((btn, index) => {
            const target = btn.dataset.tabTarget;
            if (target === tabName) {
                btn.classList.add('active');
                moveNavIndicator(index);
            } else {
                btn.classList.remove('active');
            }
        });
    }

    function moveNavIndicator(index) {
        const percent = index * 25;
        navIndicatorEl.style.transform = `translateX(${percent}%)`;
    }

    navButtons.forEach((btn, index) => {
        btn.addEventListener('click', () => {
            const target = btn.dataset.tabTarget;
            setActiveTab(target);
        });
    });

    // ==============================
    // 9. Рендер заданий
    // ==============================
    function renderTasks() {
        tasksListEl.innerHTML = '';

        tasks.forEach(task => {
            const item = document.createElement('div');
            item.className = 'task-item';

            const top = document.createElement('div');
            top.className = 'task-top';

            const left = document.createElement('div');
            const title = document.createElement('div');
            title.className = 'task-title';
            title.textContent = task.title;

            const desc = document.createElement('div');
            desc.className = 'task-desc';
            desc.textContent = task.description;

            left.appendChild(title);
            left.appendChild(desc);

            const reward = document.createElement('div');
            reward.className = 'task-reward';
            reward.textContent = `+${task.reward} ★`;

            top.appendChild(left);
            top.appendChild(reward);

            const bottom = document.createElement('div');
            bottom.className = 'task-bottom';

            const status = document.createElement('div');
            status.className = 'task-status';
            if (task.status === 'completed') {
                status.classList.add('completed');
            }

            const statusDot = document.createElement('div');
            statusDot.className = 'task-status-dot';

            const statusText = document.createElement('span');
            if (task.status === 'new') statusText.textContent = 'Новое задание';
            if (task.status === 'pending') statusText.textContent = 'Ожидает проверки';
            if (task.status === 'completed') statusText.textContent = 'Выполнено';

            status.appendChild(statusDot);
            status.appendChild(statusText);

            const actions = document.createElement('div');
            actions.className = 'task-actions';

            const startBtn = document.createElement('button');
            startBtn.className = 'btn secondary';
            startBtn.textContent = task.status === 'new' ? 'Начать' : 'Открыть';

            const checkBtn = document.createElement('button');
            checkBtn.className = 'btn';
            checkBtn.textContent = 'Проверить';

            if (task.status === 'completed') {
                checkBtn.disabled = true;
            }

            startBtn.addEventListener('click', () => {
                if (tg && task.link) {
                    tg.openTelegramLink(task.link);
                } else if (task.link) {
                    window.open(task.link, '_blank');
                }
                if (task.status === 'new') {
                    task.status = 'pending';
                    renderTasks();
                }
            });

            checkBtn.addEventListener('click', () => {
                if (task.status === 'completed') return;
                // Здесь должен быть запрос к серверу, который уже проверяет подписку/действие
                checkTaskOnServer(task);
            });

            actions.appendChild(startBtn);
            actions.appendChild(checkBtn);

            bottom.appendChild(status);
            bottom.appendChild(actions);

            item.appendChild(top);
            item.appendChild(bottom);

            tasksListEl.appendChild(item);
        });
    }

    async function checkTaskOnServer(task) {
        // ⚠️ ЭТО ШАБЛОН. На реальном сервере нужно:
        // 1) по initData понять user_id
        // 2) проверить подписку / выполнение
        // 3) вернуть { ok: true/false, alreadyCompleted: bool }
        try {
            const payload = {
                task_id: task.id
            };

            const res = await fetch(TASK_CHECK_API, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Telegram-Init-Data': tg ? tg.initData : ''
                },
                body: JSON.stringify(payload)
            });

            if (!res.ok) throw new Error('HTTP error ' + res.status);

            const data = await res.json();
            if (data.ok && !task.rewarded) {
                task.status = 'completed';
                task.rewarded = true;
                // выдать награду в виде V-монет (или просто звёзд в боте)
                const reward = Number(task.reward) || 0;
                balance += reward;
                updateBalanceUI(reward);
            } else if (data.alreadyCompleted) {
                task.status = 'completed';
            }
        } catch (err) {
            console.warn('Task check failed, используем фейковый успех для демо', err);
            // DEMO: имитация успеха
            if (!task.rewarded) {
                task.status = 'completed';
                task.rewarded = true;
                const reward = Number(task.reward) || 0;
                balance += reward;
                updateBalanceUI(reward);
            } else {
                task.status = 'completed';
            }
        } finally {
            renderTasks();
        }
    }

    // ==============================
    // 10. Лидерборд (реальный через сервер)
    // ==============================
    async function loadLeaderboard() {
        lbListEl.innerHTML = '';
        const loading = document.createElement('div');
        loading.textContent = 'Загружаем топ…';
        loading.style.fontSize = '11px';
        loading.style.color = 'var(--text-soft)';
        loading.style.textAlign = 'center';
        loading.style.paddingTop = '8px';
        lbListEl.appendChild(loading);

        try {
            const res = await fetch(LEADERBOARD_API, {
                method: 'GET',
                headers: {
                    'X-Telegram-Init-Data': tg ? tg.initData : ''
                }
            });

            if (!res.ok) throw new Error('HTTP error ' + res.status);
            const data = await res.json();

            // ожидаемый формат:
            // {
            //   "you": { "rank": 7, "score": 1200 },
            //   "top": [
            //      { "rank": 1, "name": "User", "score": 5000 },
            //      ...
            //   ]
            // }

            const you = (data && data.you) || { rank: '-', score: balance };
            const top = (data && data.top) || [];

            lbUserRankEl.textContent = you.rank || '-';
            lbUserScoreEl.innerHTML = `${you.score ?? 0}<span> V</span>`;

            lbListEl.innerHTML = '';
            top.forEach(entry => {
                const row = document.createElement('div');
                row.className = 'lb-row';

                if (you.rank && entry.rank === you.rank) {
                    row.classList.add('you');
                }

                const rank = document.createElement('div');
                rank.className = 'lb-row-rank';
                rank.textContent = entry.rank ?? '-';

                const name = document.createElement('div');
                name.className = 'lb-row-name';
                name.textContent = entry.name || 'Unknown';

                const score = document.createElement('div');
                score.className = 'lb-row-score';
                score.innerHTML = `${entry.score ?? 0}<span> V</span>`;

                row.appendChild(rank);
                row.appendChild(name);
                row.appendChild(score);

                lbListEl.appendChild(row);
            });

            if (!top.length) {
                const empty = document.createElement('div');
                empty.style.fontSize = '11px';
                empty.style.color = 'var(--text-soft)';
                empty.style.textAlign = 'center';
                empty.style.paddingTop = '8px';
                empty.textContent = 'Пока в топе никого нет. Будь первым!';
                lbListEl.appendChild(empty);
            }
        } catch (err) {
            console.warn('Leaderboard load failed, показываем демо данные', err);
            lbListEl.innerHTML = '';

            // DEMO: фейковые данные
            const demo = [
                { rank: 1, name: 'GlassLord', score: 4200 },
                { rank: 2, name: 'TapWizard', score: 3800 },
                { rank: 3, name: 'BlueGhost', score: 3500 },
                { rank: 4, name: 'NightShift', score: 3100 },
                { rank: 5, name: 'MoonTapper', score: 2700 },
                { rank: 6, name: 'SnowCoin', score: 2300 },
                { rank: 7, name: 'You', score: balance }
            ];

            lbUserRankEl.textContent = '7';
            lbUserScoreEl.innerHTML = `${balance}<span> V</span>`;

            demo.forEach(entry => {
                const row = document.createElement('div');
                row.className = 'lb-row';
                if (entry.name === 'You') {
                    row.classList.add('you');
                }

                const rank = document.createElement('div');
                rank.className = 'lb-row-rank';
                rank.textContent = entry.rank;

                const name = document.createElement('div');
                name.className = 'lb-row-name';
                name.textContent = entry.name;

                const score = document.createElement('div');
                score.className = 'lb-row-score';
                score.innerHTML = `${entry.score}<span> V</span>`;

                row.appendChild(rank);
                row.appendChild(name);
                row.appendChild(score);

                lbListEl.appendChild(row);
            });
        }
    }

    refreshLeaderboardBtn.addEventListener('click', loadLeaderboard);

    // ==============================
    // 11. Апгрейды + openInvoice
    // ==============================
    function renderUpgrades() {
        upgradesListEl.innerHTML = '';

        upgrades.forEach(upg => {
            const item = document.createElement('div');
            item.className = 'upgrade-item';
            if (upg.unlocked) {
                item.classList.add('unlocked');
            }

            const top = document.createElement('div');
            top.className = 'upgrade-top';

            const title = document.createElement('div');
            title.className = 'upgrade-title';
            title.textContent = upg.title;

            const badge = document.createElement('div');
            badge.className = 'upgrade-badge';
            badge.textContent = upg.levelLabel || 'Boost';

            top.appendChild(title);
            top.appendChild(badge);

            const desc = document.createElement('div');
            desc.className = 'upgrade-desc';
            desc.textContent = upg.description;

            const bottom = document.createElement('div');
            bottom.className = 'upgrade-bottom';

            const price = document.createElement('div');
            price.className = 'upgrade-price';
            price.innerHTML = `${upg.priceStars} ★<span> через openInvoice</span>`;

            const btn = document.createElement('button');
            btn.className = 'btn btn-danger';
            btn.textContent = upg.unlocked ? 'Куплено' : 'Купить за звёзды';

            if (upg.unlocked) {
                btn.disabled = true;
            }

            btn.addEventListener('click', () => {
                if (upg.unlocked) return;
                openUpgradeInvoice(upg);
            });

            bottom.appendChild(price);
            bottom.appendChild(btn);

            item.appendChild(top);
            item.appendChild(desc);
            item.appendChild(bottom);

            upgradesListEl.appendChild(item);
        });
    }

    function applyUpgradeEffect(upgradeId) {
        const upg = upgrades.find(u => u.id === upgradeId);
        if (!upg) return;

        if (upgradeId === 'tap_x2') {
            tapMultiplier *= 2;
        } else if (upgradeId === 'tap_x3') {
            tapMultiplier *= 3;
        } else if (upgradeId === 'auto_miner') {
            // пример: каждые 60 сек добавлять 10 V
            setInterval(() => {
                const gain = 10;
                balance += gain;
                updateBalanceUI(gain);
            }, 60000);
        }
        updateTapInfoUI();
    }

    async function openUpgradeInvoice(upg) {
        if (!tg) {
            alert('openInvoice работает только внутри Telegram Mini App.');
            return;
        }

        // Обычно инвойс создаётся ботом. Здесь мы просто открываем ссылку,
        // в которой твой бот по start-param понимает, какой апгрейд покупать.
        const url = `${INVOICE_BASE_URL}_${encodeURIComponent(upg.id)}`;

        tg.openInvoice(url, async (status) => {
            // Возможные статусы: "paid", "failed", "pending", "cancelled"
            if (status === 'paid') {
                try {
                    // Уведомляем сервер, что апгрейд куплен
                    await fetch(UPGRADE_APPLY_API, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Telegram-Init-Data': tg.initData
                        },
                        body: JSON.stringify({ upgrade_id: upg.id })
                    });
                } catch (e) {
                    console.warn('Не удалось отправить апгрейд на сервер, но локально засчитываем', e);
                }

                upg.unlocked = true;
                applyUpgradeEffect(upg.id);
                renderUpgrades();

                tg.showPopup({
                    title: 'Апгрейд активирован',
                    message: `${upg.title} теперь работает!`,
                    buttons: [{ id: 'ok', type: 'default', text: 'Ок' }]
                });
            } else if (status === 'failed') {
                tg.showPopup({
                    title: 'Ошибка оплаты',
                    message: 'Не удалось оплатить инвойс. Попробуй ещё раз.',
                    buttons: [{ id: 'ok', type: 'close', text: 'Понятно' }]
                });
            }
        });
    }

    // ==============================
    // 12. Старт приложения
    // ==============================
    function initApp() {
        initUserInfo();
        updateBalanceUI(0);
        updateTapInfoUI();
        renderTasks();
        renderUpgrades();
        loadLeaderboard();
    }

    document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
